name: PR Audit

on:
  pull_request:
    branches: [main, master]
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  audit:
    name: Code Standards Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Load configuration
        id: config
        run: |
          CONFIG_FILE=".github/coding-standards-config.yml"
          if [ -f "$CONFIG_FILE" ]; then
            # Parse YAML config (basic parsing without yq)
            ENABLED=$(grep -A1 "^pr_audit:" "$CONFIG_FILE" | grep "enabled:" | awk '{print $2}' | tr -d '"')
            THRESHOLD=$(grep -A5 "^pr_audit:" "$CONFIG_FILE" | grep "threshold:" | awk '{print $2}' | tr -d '"')
            MODE=$(grep -A5 "^pr_audit:" "$CONFIG_FILE" | grep "mode:" | awk '{print $2}' | tr -d '"')
            POST_COMMENT=$(grep -A5 "^pr_audit:" "$CONFIG_FILE" | grep "post_comment:" | awk '{print $2}' | tr -d '"')
            FAIL_ON_THRESHOLD=$(grep -A5 "^pr_audit:" "$CONFIG_FILE" | grep "fail_on_threshold:" | awk '{print $2}' | tr -d '"')
          fi

          # Set defaults if not configured
          echo "enabled=${ENABLED:-true}" >> $GITHUB_OUTPUT
          echo "threshold=${THRESHOLD:-70}" >> $GITHUB_OUTPUT
          echo "mode=${MODE:-quick}" >> $GITHUB_OUTPUT
          echo "post_comment=${POST_COMMENT:-true}" >> $GITHUB_OUTPUT
          echo "fail_on_threshold=${FAIL_ON_THRESHOLD:-true}" >> $GITHUB_OUTPUT

      - name: Check if audit is enabled
        if: steps.config.outputs.enabled != 'true'
        run: |
          echo "PR audit is disabled in configuration"
          exit 0

      - name: Detect project type
        id: detect
        run: |
          PROJECT_TYPE="unknown"

          if [ -f "composer.json" ]; then
            if grep -q "laravel/framework" composer.json 2>/dev/null; then
              PROJECT_TYPE="laravel"
            fi
          elif [ -f "package.json" ]; then
            if grep -q "next" package.json 2>/dev/null; then
              PROJECT_TYPE="nextjs"
            fi
          elif [ -f "pubspec.yaml" ]; then
            PROJECT_TYPE="flutter"
          fi

          echo "project_type=$PROJECT_TYPE" >> $GITHUB_OUTPUT
          echo "Detected project type: $PROJECT_TYPE"

      - name: Skip if unsupported project
        if: steps.detect.outputs.project_type == 'unknown'
        run: |
          echo "::notice::Project type not supported by coding standards plugin"
          exit 0

      - name: Run audit
        id: audit
        if: steps.detect.outputs.project_type != 'unknown'
        run: |
          # This is a placeholder for the actual audit logic
          # In practice, this would invoke Claude Code or run the standards checker

          PROJECT_TYPE="${{ steps.detect.outputs.project_type }}"
          MODE="${{ steps.config.outputs.mode }}"

          echo "Running $MODE audit for $PROJECT_TYPE project..."

          # Placeholder score - in real implementation this comes from audit
          # For demo purposes, generate a score based on file count
          FILE_COUNT=$(find . -type f \( -name "*.php" -o -name "*.ts" -o -name "*.tsx" -o -name "*.dart" \) | wc -l)

          # Simulate score (would be replaced with actual audit)
          SCORE=85
          ISSUES=3

          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "issues=$ISSUES" >> $GITHUB_OUTPUT
          echo "project_type=$PROJECT_TYPE" >> $GITHUB_OUTPUT

          # Generate summary
          SUMMARY="## ðŸ“‹ Coding Standards Audit

          | Metric | Value |
          |--------|-------|
          | Project Type | $PROJECT_TYPE |
          | Audit Mode | $MODE |
          | Score | $SCORE/100 |
          | Issues Found | $ISSUES |

          "

          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post PR comment
        if: steps.config.outputs.post_comment == 'true' && steps.detect.outputs.project_type != 'unknown'
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `${{ steps.audit.outputs.summary }}`;
            const score = parseInt('${{ steps.audit.outputs.score }}');
            const threshold = parseInt('${{ steps.config.outputs.threshold }}');

            let status = score >= threshold ? 'âœ… Passed' : 'âŒ Below Threshold';
            let body = summary + `\n**Status:** ${status} (threshold: ${threshold})`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('Coding Standards Audit')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Check threshold
        if: steps.config.outputs.fail_on_threshold == 'true' && steps.detect.outputs.project_type != 'unknown'
        run: |
          SCORE=${{ steps.audit.outputs.score }}
          THRESHOLD=${{ steps.config.outputs.threshold }}

          if [ "$SCORE" -lt "$THRESHOLD" ]; then
            echo "::error::Audit score ($SCORE) is below threshold ($THRESHOLD)"
            exit 1
          fi

          echo "âœ… Audit passed: $SCORE >= $THRESHOLD"
